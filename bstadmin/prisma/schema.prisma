// This is your Prisma schema file for Balisnaptrip Admin Panel
// New database - separate from main website

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUTHENTICATION ============
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  password      String?   // For admin users - hashed with bcrypt
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          UserRole  @default(CUSTOMER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Booking statistics
  totalBookings      Int      @default(0) @map("total_bookings")
  totalCancellations Int      @default(0) @map("total_cancellations")
  lastCancellationAt DateTime? @map("last_cancellation_at")
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  bookings      Booking[]
  reviews       CompanyReview[]
  
  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
  MANAGER
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============ BOOKINGS ============
model Booking {
  id                 Int       @id @default(autoincrement()) @map("booking_id")
  bookingRef         String?   @unique @map("booking_ref")
  userId             String    @map("user_id")
  packageId          Int?      @map("package_id")
  bookingDate        DateTime  @map("booking_date")
  tourName           String    @default("") @map("tour_name")
  tourDate           DateTime  @map("tour_date")
  tourTime           String?   @map("tour_time")
  
  // Multi-currency support
  totalPrice         Decimal   @map("total_price") @db.Decimal(10, 2)
  currency           String    @default("USD") @db.VarChar(3)
  totalPriceUsd      Decimal?  @map("total_price_usd") @db.Decimal(10, 2)
  totalPriceIdr      Decimal?  @map("total_price_idr") @db.Decimal(14, 0)
  fxRate             Decimal?  @map("fx_rate") @db.Decimal(12, 6)
  fxDate             DateTime? @map("fx_date")
  
  numberOfAdult      Int       @map("number_of_adult")
  numberOfChild      Int?      @map("number_of_child")
  status             BookingStatus @default(NEW)
  source             BookingSource @default(DIRECT)
  
  // Contact info
  mainContactName    String    @default("") @map("main_contact_name")
  mainContactEmail   String    @default("") @map("main_contact_email")
  phoneNumber        String    @default("") @map("phone_number")
  pickupLocation     String    @default("") @db.Text @map("pickup_location")
  meetingPoint       String    @default("") @db.Text @map("meeting_point")
  note               String?   @db.Text
  
  // Assignment
  assignedDriverId   Int?      @map("assigned_driver_id")
  assignedAt         DateTime? @map("assigned_at")
  
  // Email tracking
  rawEmailId         String?   @map("raw_email_id")
  
  // Payment (simplified - all OTA bookings are pre-paid)
  isPaid             Boolean   @default(true) @map("is_paid")
  paidAt             DateTime? @map("paid_at")
  
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user               User         @relation(fields: [userId], references: [id])
  package            TourPackage? @relation(fields: [packageId], references: [id])
  driver             Driver?      @relation(fields: [assignedDriverId], references: [id])
  finance            BookingFinance?
  reviews            Review[]
  bookingEmails      BookingEmail[]  // Many-to-many with EmailInbox (track all related emails)
  
  @@index([source])
  @@index([tourDate])
  @@index([currency])
  @@index([status])
  @@map("bookings")
}

enum BookingStatus {
  NEW          // Newly parsed booking (awaiting preparation)
  READY        // Driver + cost pattern assigned
  ATTENTION    // Tour day: needs admin attention and finance review
  COMPLETED    // Finance validated
  DONE         // Finance settled (all items paid)
  UPDATED      // OTA update received
  CANCELLED    // Cancelled by customer/OTA
  NO_SHOW      // Customer didn't show up
}

enum BookingSource {
  DIRECT       // From website
  GYG          // GetYourGuide
  VIATOR       // Viator (via Bokun)
  TRIPDOTCOM   // Trip.com
  BOKUN        // Bokun platform
  MANUAL       // Manual input by admin
}

// ============ BOOKING-EMAIL RELATIONSHIP ============

// Pivot table: Many-to-many relationship between Booking and EmailInbox
// Tracks all emails related to a booking (creation, updates, cancellations)
model BookingEmail {
  id           Int          @id @default(autoincrement())
  bookingId    Int          @map("booking_id")
  emailId      String       @map("email_id")
  relationType RelationType @map("relation_type")
  createdAt    DateTime     @default(now()) @map("created_at")

  // Relations
  booking      Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  email        EmailInbox   @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@unique([bookingId, emailId])  // Same email can only be linked once per booking
  @@index([emailId])              // Fast duplicate check
  @@index([relationType])         // Filter by relation type
  @@map("booking_emails")
}

enum RelationType {
  CREATED   // Email that created the booking
  UPDATED   // Email that updated the booking
  CANCELLED // Email that cancelled the booking
}

// ============ DRIVERS & GUIDES ============
model Driver {
  id            Int          @id @default(autoincrement())
  name          String
  email         String?      @unique
  phone         String
  vehicleType   String       @map("vehicle_type")
  vehiclePlate  String?      @map("vehicle_plate")
  licenseNumber String?      @map("license_number")
  status        DriverStatus @default(AVAILABLE)
  rating        Decimal?     @default(0) @db.Decimal(3, 2)
  photoUrl      String?      @map("photo_url")
  notes         String?      @db.Text
  
  // Rotation system
  assignmentCount     Int      @default(0) @map("assignment_count")
  priorityLevel       Int?     @map("priority_level")
  lastAssignedAt      DateTime? @map("last_assigned_at")
  
  // Cancelled booking tracking
  hasCancelledBooking Boolean  @default(false) @map("has_cancelled_booking")
  lastCancelledDate   DateTime? @map("last_cancelled_date")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  bookings Booking[]
  serviceItemLinks ServiceItemDriver[]
  financeItems BookingFinanceItem[]
  
  @@map("drivers")
}

enum DriverStatus {
  AVAILABLE
  BUSY
  OFF_DUTY
  INACTIVE
}

// ============ TOURS ============
model Tour {
  id          Int      @id @default(autoincrement()) @map("tour_id")
  tourName    String   @map("tour_name")
  slug        String   @unique
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  packages TourPackage[]

  @@map("tours")
}

// ============ TOUR PACKAGES ============
model TourPackage {
  id               Int       @id @default(autoincrement()) @map("package_id")
  tourId           Int?      @map("tour_id")
  packageName      String    @map("package_name")
  slug             String    @unique
  shortDescription String?   @map("short_description") @db.Text
  description      String?   @db.Text
  durationDays     Int?      @map("duration_days")
  
  // Multi-currency pricing (optional; income is tracked from bookings)
  pricePerPerson Decimal? @map("price_per_person") @db.Decimal(10, 2)
  pricePerChild  Decimal? @map("price_per_child") @db.Decimal(10, 2)
  baseCurrency   String  @default("USD") @db.VarChar(3) @map("base_currency")
  
  minBooking  Int?     @map("min_booking")
  maxBooking  Int?     @map("max_booking")
  isFeatured  Boolean  @default(false) @map("is_featured")
  thumbnailUrl String? @map("thumbnail_url")
  colorCode   String?  @map("color_code")
  priority    Int?     @unique
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  tour            Tour?          @relation(fields: [tourId], references: [id])
  bookings        Booking[]
  images          TourImage[]
  itineraries     TourItinerary[]
  highlights      Highlight[]
  inclusions      TourInclusion[]
  exclusions      TourExclusion[]
  additionalInfos AdditionalInfo[]
  costPatterns    TourCostPattern[]
  
  @@index([tourId])
  @@map("tour_packages")
}

model TourImage {
  id        Int      @id @default(autoincrement()) @map("image_id")
  url       String
  tourId    Int      @map("tour_id")
  createdAt DateTime @default(now()) @map("created_at")
  
  tour TourPackage @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  @@map("tour_images")
}

model Activity {
  id               Int       @id @default(autoincrement()) @map("activity_id")
  activityName     String    @map("activity_name")
  shortDescription String?   @map("short_description") @db.Text
  description      String?   @db.Text
  durationHours    Decimal?  @map("duration_hours") @db.Decimal(4, 2)
  basePrice        Decimal?  @map("base_price") @db.Decimal(10, 2)
  location         String?
  thumbnailUrl     String?   @map("thumbnail_url")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  
  itineraries TourItinerary[]
  images      ActivityImage[]
  
  @@map("activities")
}

model ActivityImage {
  id         Int      @id @default(autoincrement()) @map("image_id")
  url        String
  activityId Int      @map("activity_id")
  createdAt  DateTime @default(now()) @map("created_at")
  
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  
  @@map("activity_images")
}

model TourItinerary {
  id         Int      @id @default(autoincrement()) @map("itinerary_id")
  packageId  Int      @map("package_id")
  activityId Int      @map("activity_id")
  startTime  String   @map("start_time")
  day        Int      @default(0)
  
  package  TourPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  activity Activity    @relation(fields: [activityId], references: [id])
  
  @@map("tour_itineraries")
}

model Highlight {
  id          Int         @id @default(autoincrement()) @map("highlight_id")
  description String      @db.Text
  tourId      Int         @map("tour_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  
  tour TourPackage @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  @@map("highlights")
}

model Inclusion {
  id          Int      @id @default(autoincrement()) @map("inclusion_id")
  description String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  
  tours TourInclusion[]
  
  @@map("inclusions")
}

model Exclusion {
  id          Int      @id @default(autoincrement()) @map("exclusion_id")
  description String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  
  tours TourExclusion[]
  
  @@map("exclusions")
}

model TourInclusion {
  tourId      Int      @map("tour_id")
  inclusionId Int      @map("inclusion_id")
  createdAt   DateTime @default(now()) @map("created_at")
  
  tour      TourPackage @relation(fields: [tourId], references: [id], onDelete: Cascade)
  inclusion Inclusion   @relation(fields: [inclusionId], references: [id], onDelete: Cascade)
  
  @@id([tourId, inclusionId])
  @@map("tour_inclusions")
}

model TourExclusion {
  tourId      Int      @map("tour_id")
  exclusionId Int      @map("exclusion_id")
  createdAt   DateTime @default(now()) @map("created_at")
  
  tour      TourPackage @relation(fields: [tourId], references: [id], onDelete: Cascade)
  exclusion Exclusion   @relation(fields: [exclusionId], references: [id], onDelete: Cascade)
  
  @@id([tourId, exclusionId])
  @@map("tour_exclusions")
}

model AdditionalInfo {
  id          Int         @id @default(autoincrement()) @map("info_id")
  description String      @db.Text
  tourId      Int         @map("tour_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  
  tour TourPackage @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  @@map("additional_infos")
}

// ============ FINANCE & COSTS ============
enum PayeeType {
  DRIVER
  PARTNER
  NONE
}

enum UnitType {
  PER_BOOKING
  PER_PAX
  PER_ADULT
  PER_CHILD
}

enum FinanceDirection {
  EXPENSE
  INCOME
}

enum FinanceRelationType {
  COMMISSION_FOR
}

enum CategoryPayeeMode {
  DRIVER_ONLY
  PARTNER_ONLY
  EITHER
  NONE
}

model Partner {
  id           Int      @id @default(autoincrement()) @map("partner_id")
  name         String   @map("name")
  category     String?  @map("category")
  tourItemCategoryId   Int?     @map("category_id")
  picName      String?  @map("pic_name")
  picWhatsapp  String?  @map("pic_whatsapp")
  isActive     Boolean  @default(true) @map("is_active")
  notes        String?  @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  serviceItemLinks ServiceItemPartner[]
  financeItems     BookingFinanceItem[]
  patternItems     TourCostPatternItem[] @relation("PatternDefaultPartner")
  defaultServiceItems ServiceItem[] @relation("ServiceItemDefaultPartner")
  tourItemCategoryRef       TourItemCategory? @relation(fields: [tourItemCategoryId], references: [id])

  @@index([category])
  @@index([tourItemCategoryId])
  @@map("partners")
}

model ServiceItem {
  id        Int                @id @default(autoincrement()) @map("service_item_id")
  name      String             @map("name")
  payeeType PayeeType          @ignore @map("payee_type")
  defaultPartnerId Int?        @map("default_partner_id")
  tourItemCategoryId Int?              @map("category_id")
  isActive  Boolean            @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  defaultPartner Partner?      @relation("ServiceItemDefaultPartner", fields: [defaultPartnerId], references: [id])
  tourItemCategoryRef   TourItemCategory?      @relation(fields: [tourItemCategoryId], references: [id])
  partnerLinks ServiceItemPartner[]
  driverLinks  ServiceItemDriver[]
  patternItems TourCostPatternItem[]
  financeItems BookingFinanceItem[]

  @@index([defaultPartnerId])
  @@index([tourItemCategoryId])
  @@map("service_items")
}

model TourItemCategory {
  id        Int      @id @default(autoincrement()) @map("category_id")
  code      String   @unique @map("code")
  name      String   @map("name")
  defaultDirection FinanceDirection @default(EXPENSE) @map("default_direction")
  payeeMode CategoryPayeeMode @default(PARTNER_ONLY) @map("payee_mode")
  autoDriverFromBooking Boolean @default(false) @map("auto_driver")
  isCommission Boolean @default(false) @map("is_commission")
  allowRelatedItem Boolean @default(false) @map("allow_related_item")
  requirePartner Boolean @default(false) @map("require_partner")
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int?     @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  partners     Partner[]
  serviceItems ServiceItem[]

  @@map("categories")
}

model ServiceItemPartner {
  serviceItemId Int      @map("service_item_id")
  partnerId     Int      @map("partner_id")
  createdAt     DateTime @default(now()) @map("created_at")

  serviceItem ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)
  partner     Partner     @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@id([serviceItemId, partnerId])
  @@map("service_item_partners")
}

model ServiceItemDriver {
  serviceItemId Int      @map("service_item_id")
  driverId      Int      @map("driver_id")
  createdAt     DateTime @default(now()) @map("created_at")

  serviceItem ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)
  driver      Driver      @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@id([serviceItemId, driverId])
  @@map("service_item_drivers")
}

model TourCostPattern {
  id        Int     @id @default(autoincrement()) @map("pattern_id")
  packageId Int     @map("package_id")
  name      String  @map("name")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  package         TourPackage          @relation(fields: [packageId], references: [id], onDelete: Cascade)
  items           TourCostPatternItem[]
  bookingFinances BookingFinance[]

  @@index([packageId])
  @@map("tour_cost_patterns")
}

model TourCostPatternItem {
  id              Int      @id @default(autoincrement()) @map("pattern_item_id")
  patternId       Int      @map("pattern_id")
  serviceItemId   Int      @map("service_item_id")
  defaultPartnerId Int?    @map("default_partner_id")
  defaultUnitType UnitType @map("default_unit_type")
  defaultQty      Int      @default(1) @map("default_qty")
  defaultPrice    Decimal  @db.Decimal(12, 2) @map("default_price")
  position        Int?     @map("position")

  createdAt DateTime @default(now()) @map("created_at")

  pattern     TourCostPattern @relation(fields: [patternId], references: [id], onDelete: Cascade)
  serviceItem ServiceItem     @relation(fields: [serviceItemId], references: [id])
  defaultPartner Partner?     @relation("PatternDefaultPartner", fields: [defaultPartnerId], references: [id])

  @@index([patternId])
  @@index([serviceItemId])
  @@index([defaultPartnerId])
  @@map("tour_cost_pattern_items")
}

model BookingFinance {
  id          Int      @id @default(autoincrement()) @map("booking_finance_id")
  bookingId   Int      @unique @map("booking_id")
  patternId   Int?     @map("pattern_id")
  assignedAt  DateTime @default(now()) @map("assigned_at")
  validatedAt DateTime? @map("validated_at")
  isLocked    Boolean  @default(false) @map("is_locked")
  notes       String?  @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  pattern TourCostPattern? @relation(fields: [patternId], references: [id])
  items   BookingFinanceItem[]

  @@index([patternId])
  @@map("booking_finances")
}

model BookingFinanceItem {
  id               Int                 @id @default(autoincrement()) @map("finance_item_id")
  bookingFinanceId Int                 @map("booking_finance_id")
  serviceItemId    Int?                @map("service_item_id")
  nameSnapshot     String              @map("name_snapshot")
  tourItemCategoryIdSnapshot Int?              @map("category_id_snapshot")
  tourItemCategoryNameSnapshot String?          @map("category_name_snapshot")
  isCommissionSnapshot Boolean          @default(false) @map("is_commission_snapshot")
  allowRelatedItemSnapshot Boolean      @default(false) @map("allow_related_item_snapshot")
  direction        FinanceDirection    @default(EXPENSE) @map("direction")
  payeeType        PayeeType           @default(NONE) @map("payee_type")
  isManual         Boolean             @default(false) @map("is_manual")
  unitType         UnitType            @map("unit_type")
  unitQty          Int                 @default(1) @map("unit_qty")
  unitPrice        Decimal             @db.Decimal(12, 2) @map("unit_price")
  amount           Decimal             @db.Decimal(12, 2) @map("amount")
  commissionAmount       Decimal       @default(0) @db.Decimal(12, 2) @map("commission_amount")
  commissionDriverAmount Decimal       @default(0) @db.Decimal(12, 2) @map("commission_driver_amount")

  driverId     Int? @map("driver_id")
  partnerId    Int? @map("partner_id")
  relatedItemId Int? @map("related_item_id")
  relationType  FinanceRelationType? @map("relation_type")

  paid     Boolean   @default(false)
  paidAt   DateTime? @map("paid_at")
  paidBy   String?   @map("paid_by")
  paidNote String?   @db.Text @map("paid_note")
  notes    String?   @db.Text @map("notes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  bookingFinance BookingFinance @relation(fields: [bookingFinanceId], references: [id], onDelete: Cascade)
  serviceItem    ServiceItem?   @relation(fields: [serviceItemId], references: [id])
  driver         Driver?        @relation(fields: [driverId], references: [id])
  partner        Partner?       @relation(fields: [partnerId], references: [id])
  relatedItem    BookingFinanceItem? @relation("FinanceItemRelation", fields: [relatedItemId], references: [id])
  relatedItems   BookingFinanceItem[] @relation("FinanceItemRelation")

  @@index([bookingFinanceId])
  @@index([serviceItemId])
  @@index([driverId])
  @@index([partnerId])
  @@index([paid])
  @@map("booking_finance_items")
}

model Review {
  id        Int      @id @default(autoincrement()) @map("review_id")
  bookingId Int      @map("booking_id")
  rating    Decimal  @db.Decimal(2, 1)
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  booking Booking @relation(fields: [bookingId], references: [id])
  
  @@map("reviews")
}

model CompanyReview {
  id        Int      @id @default(autoincrement()) @map("company_review_id")
  userId    String   @map("user_id")
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id])
  
  @@map("company_reviews")
}

// ============ EMAIL INGESTION ============
model EmailInbox {
  id            String      @id @default(cuid())
  messageId     String      @unique @map("message_id")
  subject       String
  from          String
  to            String
  receivedAt    DateTime    @map("received_at")
  body          String      @db.Text
  htmlBody      String?     @map("html_body") @db.Text

  // Email classification (not status)
  isBookingEmail Boolean     @default(false) @map("is_booking_email")
  source         BookingSource
  parsedData     Json?       @map("parsed_data")
  errorMessage   String?     @map("error_message") @db.Text

  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  jobs           EmailJob[]
  bookingEmails  BookingEmail[]  // Many-to-many with Booking

  @@index([isBookingEmail])
  @@index([source])
  @@index([receivedAt])
  @@map("email_inbox")
}

// EmailStatus enum removed - replaced with isBookingEmail boolean flag

// Database-based job queue (replaces BullMQ/Redis)
model EmailJob {
  id            String    @id @default(cuid())
  emailInboxId  String    @map("email_inbox_id")
  status        JobStatus @default(PENDING)
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3) @map("max_attempts")
  error         String?   @db.Text
  
  createdAt   DateTime  @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")
  nextRetryAt DateTime? @map("next_retry_at")
  
  // Relations
  emailInbox EmailInbox @relation(fields: [emailInboxId], references: [id], onDelete: Cascade)
  
  @@index([status, nextRetryAt])
  @@index([emailInboxId])
  @@map("email_jobs")
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============ AUDIT LOGS ============
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  action    String   // CREATE, UPDATE, DELETE, LOGIN, etc
  entity    String   // Booking, Driver, TourPackage, etc
  entityId  String?  @map("entity_id")
  oldValue  Json?    @map("old_value")
  newValue  Json?    @map("new_value")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============ NOTIFICATIONS ============
model Notification {
  id        String           @id @default(cuid())
  userId    String?          @map("user_id")
  type      NotificationType
  title     String
  message   String           @db.Text
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  
  createdAt DateTime  @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")
  
  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  BOOKING_NEW
  BOOKING_UPDATE
  BOOKING_CANCEL
  DRIVER_ASSIGNED
  EMAIL_FAILED
  SYSTEM
}

// ============ SYSTEM SETTINGS ============
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json     // Store JSON config
  category  String   @default("general")
  updatedBy String?  @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([category])
  @@map("system_settings")
}
